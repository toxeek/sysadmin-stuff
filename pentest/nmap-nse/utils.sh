################
install_nse_utils() {
    while read SNE_UTIL; do 
        if echo $SNE_UTIL | grep -q "#"; then
            continue
        fi
        util="$(echo $SNE_UTIL | $AWK -F"=" '{print $1}')"
        val="$(echo $SNE_UTIL | $AWK -F"=" '{print $2}')"
        if [[ "$val" -eq "1" ]]; then
            sleep 1 && echo "[~] adding $util to array nmap nse utils array.." && nmap_nse_utils_array+=($util)
        fi
    done < $nmap_nse_cfg_file

    # echo "[+] debugging nse array: ${nmap_nse_utils_array[*]}"
}
################
install_nse_http_headers() {
    echo
    echo "[+] output of your version and info from your nmap installation:"
    $(which nmap) --version
    echo
    for m in /usr/share/nmap/nselib/http.lua /usr/share/nmap/nselib/shortport.lua /usr/share/nmap/nselib/stdnse.lua /usr/share/nmap/scripts/http-headers.nse; do  rm -f $m; 
    done
    echo "[+] installing http-headers nse .."
    echo "[+] checking for nmap .."
    echo
    [[ ! $(which nmap) ]] && echo "[+] you have not nmap installed, exiting." && return 1
    [ ! -d "/usr/share/nmap" ] && echo "[+] this is for Ubuntu 20.04 LTS, /usr/share/nmap not found." && return 1

    echo "[+] installing dependencies .."
    if [ ! -r "/usr/share/nmap/nselib/http.lua" ] ; then 
        ${WGET} https://svn.nmap.org/nmap/nselib/http.lua -O /usr/share/nmap/nselib/http.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/shortport.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/shortport.lua -O /usr/share/nmap/nselib/shortport.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/stdnse.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/stdnse.lua -O /usr/share/nmap/nselib/stdnse.lua 2>&1
    fi
    echo
    echo "[+] installing http-headers nse script .."
    if [ -r "/usr/share/nmap/scripts/http-headers.nse" ] ; then
        echo 
        echo "[+] you have already installed the http-headers nse script.." && return 1
    else
        ${WGET} https://svn.nmap.org/nmap/scripts/http-headers.nse -O /usr/share/nmap/scripts/http-headers.nse
    fi
    echo "[+] nmap nse http-headers script installed."
    echo "[+] example usage: nmap -vvv -p80,81,8080 -sT -Pn --script=http-headers --max-rate 58.71.208.99"
    echo "[+] let's give it a go with the example IP .. executing nmap with the http-headers script .."
    echo "$(which nmap) -vvv -p80,81,8080 -sT -Pn --script=http-headers --max-rate 162 58.71.208.43.99"
    $(which nmap) -vvv -p"80,81,8080" -sT -Pn --script=http-headers --max-rate 100 "58.71.208.99"

    return 0
}
################
install_http_enum() {
    if [ ! -r "/usr/share/nmap/nselib/http.lua" ] ; then
       echo "[+] installing base http nse http script .."
       ${WGET} https://svn.nmap.org/nmap/nselib/http.lua -O /usr/share/nmap/nselib/http.lua
    elif [ ! -r "/usr/share/nmap/nselib/shortport.lua" ] ; then
      ${WGET} https://svn.nmap.org/nmap/nselib/shortport.lua -O /usr/share/nmap/nselib/shortport.lua
    elif [ ! -r "/usr/share/nmap/nselib/stdnse.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/stdnse.lua -O /usr/share/nmap/nselib/shortport.lua
    elif [ ! -r "/usr/share/nmap/scripts/http-enum.nse" ] ; then
        ${WGET} https://svn.nmap.org/nmap/scripts/http-enum.nse -O /usr/share/nmap/scripts/http-enum.nse
    else 
        echo "[+] sounds like we have http-enum nmap sne script is already installed .."
        echo
        echo "[+] nmap nse http-enum script installed."
        echo "[+] example usage: nmap -vv -sV -Pn --script=http-enum --max-rate 100 58.71.208.99"
        echo "[+] let's give it a go with the example IP .. executing nmap with the http-enum script .."
        echo
        echo "$(which nmap) -vvv -sV -Pn --script=http-enum --max-rate 100 58.71.208.43"
        echo
        echo "[+] give it some time .. this plugin is agressive, changin max-rate to 100 pkts/s .."
        echo "[+] this plugin may otherwise leave you (depending on your ISP contracted bandwidth) with no Internet connection .."
        echo
        $(which nmap) -vvv -sV -Pn --script=http-enum --max-rate 100 --scan-delay 30 "58.71.208.38"
    fi

    return 0
}
################

install_nse_utils
install_nmap_nse_utils() {
    for util in ${nmap_nse_utils_array[*]}; do
        if [[ "$util" == *http-headers* ]] ; then
            install_nse_http_headers
        elif [[ "$util" == *http-enum* ]] ; then
            install_http_enum
        else 
            echo "[+] nothing else to install about nse scripts .."
        fi

    done
 
    echo
    echo '############### nmap nse utils installed ###############'
    echo
    return 0
}
################
