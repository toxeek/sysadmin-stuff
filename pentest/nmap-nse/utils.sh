################
install_nse_utils() {
    echo '############### adding nmap nse utils ###############'
    while read SNE_UTIL; do 
        if echo $SNE_UTIL | grep -q "#"; then
            continue
        fi
        util="$(echo $SNE_UTIL | $AWK -F"=" '{print $1}')"
        val="$(echo $SNE_UTIL | $AWK -F"=" '{print $2}')"
        if [[ "$val" -eq "1" ]]; then
            sleep 1 && echo "[~] adding $util to array nmap nse utils array.." && nmap_nse_utils_array+=($util)
        fi
    done < $nmap_nse_cfg_file

    # echo "[+] debugging nse array: ${nmap_nse_utils_array[*]}"
}
################
nse_basic_check() {
    [[ ! $(which nmap) ]] && echo "[+] you have not nmap installed, exiting." && return 1
    [ ! -d "/usr/share/nmap" ] && echo "[+] this is for Ubuntu 20.04 LTS, /usr/share/nmap not found." && return 1
}
################
install_nse_http_headers() {
    echo
    echo "[+] output of your version and info from your nmap installation:"
    $(which nmap) --version
    echo
    echo "[+] installing http-headers nse .."
    echo "[+] checking for nmap .."
    echo

    # nse_basic_check
    
    echo "[+] installing dependencies .."
    if [ ! -r "/usr/share/nmap/nselib/http.lua" ] ; then 
        ${WGET} https://svn.nmap.org/nmap/nselib/http.lua -O /usr/share/nmap/nselib/http.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/shortport.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/shortport.lua -O /usr/share/nmap/nselib/shortport.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/stdnse.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/stdnse.lua -O /usr/share/nmap/nselib/stdnse.lua 2>&1
    fi
    echo
    echo "[+] installing http-headers nse script .."
    if [ ! -r "/usr/share/nmap/scripts/http-headers.nse" ] ; then
        ${WGET} https://svn.nmap.org/nmap/scripts/http-headers.nse -O /usr/share/nmap/scripts/http-headers.nse
    fi

    echo "[+] nmap nse http-headers script installed."
    echo "[+] example usage: nmap -vvv -p80,81,8080 -sT -Pn --script=http-headers --max-rate 100 58.71.208.99"
    # echo "[+] let's give it a go with the example IP .. executing nmap with the http-headers script .."
    echo "$(which nmap) -vvv -p80,81,8080 -sT -Pn --script=http-headers --max-rate 162 58.71.208.43.99"
    # $(which nmap) -vvv -p"80,81,8080" -sT -Pn --script=http-headers --max-rate 100 "58.71.208.99"

    return 0
}
################
install_nse_dns_brute() {
    echo
    echo "[+] installing dns-brute nse .."
    echo "[+] checking for nmap .."
    echo

    # nse_basic_check

    echo "[+] installing dependencies .."
    if [ ! -r "/usr/share/nmap/nselib/stringaux.lua" ] ; then 
        ${WGET} https://svn.nmap.org/nmap/nselib/stringaux.lua -O /usr/share/nmap/nselib/stringaux.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/dns.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/dns.lua -O /usr/share/nmap/nselib/dns.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/target.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/target.lua -O /usr/share/nmap/nselib/target.lua 2>&1
    fi
    if [ ! -r "/usr/share/nmap/nselib/rand.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/rand.lua -O /usr/share/nmap/nselib/rand.lua 2>&1
    fi

    echo
    echo "[+] installing dns-brute nse script .."
    if [ ! -r "/usr/share/nmap/scripts/dns-brute.nse" ] ; then
        ${WGET} https://svn.nmap.org/nmap/scripts/dns-brute.nse -O /usr/share/nmap/scripts/dns-brute.nse
    fi

    echo "[+] nmap nse dns-brute script installed."
    echo "[+] example usage: nmap -vvv -p80,443 -sT -Pn --script=dns-brute --max-rate 100 domain.com"
    echo "[+] let's give it a go with an example domain .. executing nmap with the dns-brute script .."
    echo "$(which nmap) -vvv -p80,443 -sT -Pn --script=dns-brute --max-rate 162 imperial.ac.uk"
    $(which nmap) -vvv -p"80,81,8080" -sT -Pn --script=dns-brute --max-rate 100 "imperial.ac.uk"

    return 0
}
################
install_nse_http_enum() {
    echo
    echo "[+] installing http-enum nse .."
    echo "[+] checking for nmap .."
    echo

    # nse_basic_check

    echo "[+] installing dependencies .."
    if [ ! -r "/usr/share/nmap/nselib/http.lua" ] ; then
       ${WGET} https://svn.nmap.org/nmap/nselib/http.lua -O /usr/share/nmap/nselib/http.lua
    elif [ ! -r "/usr/share/nmap/nselib/shortport.lua" ] ; then
      ${WGET} https://svn.nmap.org/nmap/nselib/shortport.lua -O /usr/share/nmap/nselib/shortport.lua
    elif [ ! -r "/usr/share/nmap/nselib/stdnse.lua" ] ; then
        ${WGET} https://svn.nmap.org/nmap/nselib/stdnse.lua -O /usr/share/nmap/nselib/shortport.lua
    elif [ ! -r "/usr/share/nmap/scripts/http-enum.nse" ] ; then
        ${WGET} https://svn.nmap.org/nmap/scripts/http-enum.nse -O /usr/share/nmap/scripts/http-enum.nse
    else 
        echo "[+] sounds like we have http-enum nmap nse script is already installed .."
        echo
        echo "[+] nmap nse http-enum script installed."
        echo "[+] example usage: nmap -vv -sV -Pn --script=http-enum --max-rate 100 58.71.208.99"
        # echo "[+] let's give it a go with the example IP .. executing nmap with the http-enum script .."
        echo
        echo "$(which nmap) -vvv -sV -Pn --script=http-enum --max-rate 100 58.71.208.43"
        echo
        echo "[+] give it some time .. this plugin is agressive, changin max-rate to 100 pkts/s .."
        echo "[+] this plugin may otherwise leave you (depending on your ISP contracted bandwidth) with no Internet connection .."
        # $(which nmap) -vvv -sV -Pn --script=http-enum --max-rate 100 "58.71.208.72"
    fi

    return 0
}
################
install_vulscan_nse() {
    echo
    echo "[+] installing vulscan nse .."
    if [ ! -r "/usr/share/nmap/scripts/vulscan" ]; then 
        CWD=$(pwd)
        cd /usr/local/src/
        $(which git) clone https://github.com/scipag/vulscan scipag_vulscan
        ln -s `pwd`/scipag_vulscan /usr/share/nmap/scripts/vulscan
        cd ${CWD}
    fi

    return 0
}
#################

install_nse_utils
install_nmap_nse_utils() {
    for util in ${nmap_nse_utils_array[*]}; do
        if [[ "$util" == *http-headers* ]] ; then
            install_nse_http_headers
        elif [[ "$util" == *http-enum* ]] ; then
            install_nse_http_enum
        elif [[ "$util" == *dns-brute* ]] ; then
            install_nse_dns_brute
        elif [[ "$util" == *vulscan* ]] ; then
            install_vulscan_nse
        else 
            echo "[+] nothing else to install about nse scripts .."
        fi
    done
    echo

    return 0
}
################
