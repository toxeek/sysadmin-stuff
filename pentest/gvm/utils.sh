################
install_gvm_util() {
    echo '############### installing gvm utils ###############'
    while read GVM_UTIL; do 
        if echo $GVM_UTIL | grep -q "#"; then
            continue
        fi
        util="$(echo $GVM_UTIL | $AWK -F"=" '{print $1}')"
        val="$(echo $GVM_UTIL | $AWK -F"=" '{print $2}')"
        if [[ "$val" -eq "1" ]]; then
            sleep 1 && echo "[~] adding $util to gvm utils array.." && gvm_utils_array+=($util)
        fi
        [[ ${gvm_utils_array[*]} -lt 1 ]] && echo "[+] OpenVAS/GVM disablled, all done, exiting." && exit 125
    done < $gvm_cfg_file
}
################
disable_ipv6_updates() {
    echo "[+] these updates will fail per ipv6 used .. disabling"
    cat > /etc/apt/apt.conf.d/99force-ipv4 <<EOF
Acquire::ForceIPv4 "true";
EOF
    ${APT} update

    return 0
}
#################
install_gvm() {
    add-apt-repository ppa:mrazavi/gvm
    ${APT} install postgresql
    ${APT} update
    ${APT} install gvm
    greenbone-nvt-sync
    greenbone-scapdata-sync
    greenbone-certdata-sync

    sed -e -i 's/GSA_ADDRESS=127.0.0.1/GSA_ADDRESS=0.0.0.0/' /etc/default/gsad
    sed -e -i 's/databases 16/databases 28/' /etc/redis/redis.conf
    redis-cli -s /var/run/redis/redis.sock flushall

    return 0
}
#################
update_nvt_cronjobs() {
    ## still to do .. and add to the installation
    echo "[+] setting up cron jobs for nvt updates .."
    cat > /etc/cron.daily/gvm <<EOF
#!/usr/bin/env bash

/usr/bin/sudo -iu gvm $(which greenbone-nvt-sync)
EOF

    return 0
}
#################

install_gvm_util
install_gvm_utils() {
    echo '############### installing GVM utils ###############'
    for util in ${gvm_utils_array[*]}; do
        if [[ "$util" == *gvm* ]] ; then
            disable_ipv6_updates
            install_gvm
            update_nvt_cronjobs
        else 
            echo 
            echo "[+] installing ${util} .."
            ${APT} -y install ${util}
        fi

    done

    echo '############### GVM utils installed ###############'
    echo

    return 0
}